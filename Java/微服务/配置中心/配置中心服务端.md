# 配置中心服务端

`Spring Cloud Config Server` 为外部配置（键值对或等价的YAML内容）提供了一个基于资源的HTTP API。服务端可以通过 `@EnableConfigServer` 注解，内嵌到Spring Boot应用中。因此，以下的应用就是一个配置中心服务端：  

***ConfigServer.java***  

```java
@SpringBootApplication
@EnableConfigServer
public class ConfigServer {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServer.class, args);
    }
}
```

就如Spring Boot应用一样，它默认运行在 `8080` 端口，但是你可以通过很多方式，将它切换为更为方便的 `8888` 端口。最简单的方式是配置 `spring.config.name=configserver` （在Config Server jar包中有一个 `configserver.yml`文件），它会设置一个默认的配置仓库。另一种方式是使用你自己的 `application.properties(yml)` 文件，正如下面的例子：  

***application.properties***  

```properties
server.port: 8888
spring.cloud.config.server.git.uri: file://${user.home}/config-repo
```

***application.yml***  

```yaml
server:
  port: 8888
spring:
  cloud:
    config:
      server:
        git:
          uri: file://${user.home}/config-repo
```

其中，`${user.home}/config-repo` 是一个包含了YAML文件和properties文件的git仓库。

> 在Windows，如果仓库地址带有盘符前缀，你需要在URL中添加一个额外的 "/"，例如：file:///${user.home}/config-repo 。

> 下面的展示了在前面的示例中创建Git存储库的方法：  
>
> $ cd ~  
>
> $ mkdir config-repo  
>
> $ cd config-repo  
>
> $ git init .  
>
> $ echo info.foo: bar > application.properties  
>
> $ git add -A .  
>
> $ git commit -m "Add application.properties"

> 如果配置仓库中仅存放了文本文件，那么初次克隆是非常快速高效的。如果你存储了二进制文件，尤其是二进制大文件，那么你在克隆时将会体验到极大的延迟，甚至抛出内存错误异常。

## 环境仓库

你应该将配置中心服务端的配置存放在哪呢？控制存储策略的行为都交给 `EnvironmentRepository` 了，它的作用是保存 `Environment` 对象。此 `Environment` 是 `Spring Environment` 对象的浅拷贝（包括 `PropertySources` ）。`Environment` 的资源被三个变量参数化：  

- `{application}` ：映射到客户端的 `spring.application.name` 配置项；
- `{profile}` ：映射到客户端的 `spring.profiles.active` 配置项（由都好分割的list）；
- `label` ：它是服务端的特性，是配置文件的版本控制标签；

仓库的具体行为类似与Spring Boot应用程序。加载配置文件的规则如下：  

-  找到 `spring.config.name` 等于 `{application}` 参数的文件；
- 找到 `spring.profiles.active` 等于 `{profile}` 参数的文件；

配置文件的优先级也与普通的Spring Boot应用相同：

- 通过active激活的配置的优先级高于默认的；
- 如果以上的存在有多个配置文件，则最后一个的优先级高；

eg，以下的示例应用拥有bootstrap配置文件：  

***bootstrap.yml***  

```yaml
spring:
  application:
    name: foo
  profiles:
    active: dev,mysql
```

（Spring Boot应用程序也可以通过环境变量或命令行参数设置这些属性。）  

  

如果仓库是基于文件的，那么服务端将从 `application.yml` （所有客户端共享）和 `foo.yml`文件（优先）创建 `Environment` 对象。如果YAML文件拥有指向Spring配置文件的内容，则这些Spring配置文件拥有较高优先级；如果有指定profile的YAML(properties)文件，则它们拥有比默认文件更高的优先级。拥有高优先级的文件内容，会被传到上面 `Environment` 对象中的 `PropertySource` 对象中。  

  

您可以将 `spring.cloud.config.server.accept-empty` 设置为 `false` （默认是true），当通过 `{application}` 查找失败时，将返回HTTP 404状态。  



### Git作为存储仓库

`EnvironmentRepository` 默认使用GIT作为存储仓库，这样我们可以很方便地去管理升级、和回顾变更。可以通过 `spring.cloud.config.server.git.uri` 属性来更改仓库地址。如果你赋给这个属性的值以 `file:` 为前缀，则它会使用本地的git仓库，这样一来你可以免去git远程仓库，快速简单地使用配置中心。然而，在使用本地仓库时，服务端不会去 `clone` 本地仓库，而是直接再其上操作（这没什么问题，因为服务端永远不会改变git仓库的内容）。  

为了使得配置中心服务端高可用，你需要将所有的配置中心服务端实例都指向同一个git远程仓库，并且最好使用ssh协议。这样服务端就可以克隆它并使用本地工作副本作为缓存。  

git存储仓库会将HTTP资源中的 `label` 参数映射到git的label（提交id、分支名、标签）。如果git的分支或标签名字包含 `/` ，则在HTTP URL中应该将 `/` 替换为 `(_)`。例如，git label名字是"foo/bar" ，则HTTP URL中应该写为"foo(_)bar"。这个规则同样适用与 `{application}` 参数。如果你使用类似于 `curl` 这样的网络工具，则要小心括号的使用，应该使用 `"` 进行转义。  

***跳过SSL证书验证***  

```yaml
spring:
  cloud:
    config:
      server:
        git:
          uri: https://example.com/my/repo
          # 默认是false
          skipSslValidation: true
```

***设置HTTP的超时时间***  

```yaml
spring:
  cloud:
    config:
      server:
        git:
          uri: https://example.com/my/repo
          # 单位是秒
          timeout: 4
```

***仓库地址使用占位符***  

`{application}` 、 `{profile}` 和 `label` 都支持占位：  

```yaml
spring:
  cloud:
    config:
      server:
        git:
          uri: https://github.com/myorg/{application}
```

